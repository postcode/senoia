<%= simple_form_for @plan do |f| %>
  <% if @plan.errors.any? %>
  <div class="large-12 columns">
    <div class="row">
      <div class="large-12 columns">
        <div id="error_explanation">
          <h4><%= pluralize(@plan.errors.count, "error") %> prohibited this plan from being saved:</h4>
          <ul>
            <% @plan.errors.full_messages.each do |msg| %>
              <li><%= msg %></li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <% end %>
  <div class="large-12 columns">
    <div class="row">
      <div class="large-8 columns pageTitle">
        <h1><%= f.input :name, label: false %></h1>
      </div>
      <div class="large-3 columns end pageTitle">
        <p>EDIT MODE<br>
          <em>Last Updated: <%= @plan.updated_at.strftime("%D %l:%M %P") %></em></p>
      </div>
    </div>
  </div>
  <%= render 'plan_state' %>
  <div class="large-12 columns plan_form">
    <div class="row">
      <div class="large-8 columns">
        <fieldset>
          <legend>EVENT PLAN CREATOR</legend>
          <% if @plan.creator.present? %>
            <p><i class="fi-mail"></i> <%= @plan.creator.email %></p>
            <p><i class="fi-telephone"></i> <%= @plan.creator.phone_number.phony_formatted(format: :national, spaces: ' ') %></p>
          <% else %>
            <%= f.association :creator,
                              collection: User.all,
                              label_method: :email,
                              value_method: :id,
                              include_blank: false,
                              label: false %>
          <% end %>
        </fieldset>
      </div>
      <div class="large-4 columns end">
        <%= render 'comment_form', plan: @plan, title: "contact" %>
      </div>
    </div>
    <div class="row">
      <div class="large-8 columns">
        <fieldset>
          <legend>COLLABORATORS</legend>
          <div class="row">
            <div class="large-9 columns">
              <table id="users_table">
                <thead>
                  <th>Email</th>
                  <th>Role</th>
                </thead>
                <tbody>
                  <% @plan.users.each do |user| %>
                    <tr>
                      <td><%= user.email %></td>
                      <td><%= PlanUser.where(user_id: user.id, plan_id: @plan.id).first.present? ? PlanUser.where(user_id: user.id, plan_id: @plan.id).first.role : nil %></td>
                      <td><%= link_to "Remove", remove_user_plan_path(plan_id: @plan.id, user_id: user.id), method: :delete %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
            <div class="large-3 columns">
              <a id="new_plan_user_button" href="#" data-reveal-id="new-plan-user" class="button tiny radius"><i class="fi-plus"></i> ADD USERS</a>
              <%= render 'new_plan_user', :plan => @plan %>
            </div>
          </div>
        </fieldset>
      </div>
      <div class="large-4 columns end">
        <% if @plan.id.present? && !@plan.draft? %>
          <%= render 'comment_form', plan: @plan, title: "collaborators" %>
        <% end %>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="small-3 columns input_label">
      <%= f.label :event_type %>
    </div>
    <div id="stepThree" class="small-5 columns">
      <% if can? :edit, @plan %>
        <%= f.association :event_type,
        collection: EventType.all,
        label_method: :name,
        value_method: :id,
        include_blank: false,
        label: false %>
      <% else %>
        <p>
          <%= @plan.event_type %>
        </p>
      <% end %>
    </div>
    <div class="large-4 columns end">
      <%= render 'comment_form', plan: @plan, title: "event_type" %>
    </div>
  </div>

  <div class="row">
    <div class="small-3 columns input_label">
      <%= f.label :organization, class: "inline", required: true, label: "Permitting Agency" %>
    </div>
    <div id="stepFour" class="small-5 columns">
      <%= f.association :organization,
                        collection: OrganizationType.find_permitters,
                        label_method: :name,
                        value_method: :id,
                        include_blank: false,
                        label: false,
                        prompt: "(Please select)"%>
      <%= render partial: "permitters/permitter", collection: OrganizationType.find_permitters, permitter: @plan.permitter %>
    </div>
    <div class="large-4 columns end">
      <%= render 'comment_form', plan: @plan, title: "permitter" %>
    </div>
  </div>
  <div class="row">
    <div class="small-3 columns input_label">
      <%= f.label :alcohol, class: "inline", required: true %>
    </div>
    <div id="stepFive" class="small-5 columns">
      <%= f.input :alcohol, as: :radio_buttons, label: false %>
    </div>
    <div class="large-4 columns end">
      <%= render 'comment_form', plan: @plan, title: "alcohol" %>
    </div>
  </div>
  <div class="row">
    <div class="small-3 columns input_label">
      <%= f.label :venue_id, class: "inline", required: false %>
    </div>
    <div id="stepSix" class="small-5 columns input_label">
      <%= f.association :venues, input_html: {class: "chosen-input", placeholder: "Type a venue name", multiple: false}, label: false %>
    </div>
    <div class="large-4 columns end">
      <%= render 'comment_form', plan: @plan, title: "venue" %>
    </div>
  </div>
  <hr/>

  <%= render 'operation_periods_container', f: f %>
  <%= render 'plan_agreement', plan: @plan, f: f %>
  <%= render "supplementary_documents/index", parent: @plan, f: f %>

   <div id="stepFifteen" class="row">
      <fieldset>
        <legend>POST EVENT TREATMENT REPORT CREATOR</legend>
        <div class="row">
          <div class="large-4 columns">
            <%= f.input :post_event_name, required: true, label: "Name" %>
            <%= f.input :post_event_email, required: true, label: "Email" %>
            <%= f.input :post_event_phone, required: true, label: "Phone Number" %>
          </div>
        </div>
      </fieldset>
    </div>

  <% if can? :edit, @plan %>
  <div class="plan_action_container">
    <%= render 'actions', f: f, plan: @plan %>
  </div>
    <%= render 'floating_save', f: f, plan: @plan %>
  <% end %>
<% end %>

<% if @plan.draft? %>
   <%= render 'shared/joyride' %>
<% end %>

<script>
$(document).ready(function() {
  $(document).foundation().foundation('joyride', 'start');
  $('#plan_organization_id').chosen({
    width: "100%",
    enable_split_word_search: true,
    search_contains: true
  });

  $('.chosen-input').chosen({
      width: "100%",
      enable_split_word_search: true,
      search_contains: true
  });
  $('#plan_event_type_id').chosen({
    width: "100%",
    enable_split_word_search: true,
    search_contains: true
  });
});
</script>
