<%= simple_form_for [@plan] do |f| %>
  <% if @plan.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@plan.errors.count, "error") %> prohibited this department from being saved:</h2>
      <ul>
      <% @plan.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>
  <div class="large-12 columns">
    <div class="row">
      <div class="large-7 columns pageTitle">
        <h1><%= f.input :name, label: false %></h1>
      </div>
      <div class="large-3 columns text-right pageTitle">
        <p><em>UPDATED: <%= @plan.updated_at.strftime("%D %l:%M %P") %></em></p>
      </div>
    </div>
  </div>
  <%= render 'plan_state' %>
  <div class="large-12 columns plan_form">
      <div class="row">
        <div class="large-8 columns">
          <fieldset>
            <legend>EVENT PLAN CREATOR</legend>   
              <% if @plan.creator.present? %>
              <p><i class="fi-mail"></i> <%= @plan.creator.email %></p>
              <p><i class="fi-telephone"></i> <%= @plan.creator.phone_number %></p>   
            <% else %>
               <%= f.association :creator,
                                collection: User.all,
                                label_method: :email,
                                value_method: :id,
                                include_blank: false,
                                label: false %>
            <% end %> 
          </fieldset>   
        </div>
        <div class="large-4 columns end">
          <%= render 'comment_form', plan: @plan, title: "contact" %>
        </div>
      </div>
        <div class="row">
          <div class="large-8 columns">
            <fieldset>
              <legend>COLLABORATORS</legend>
                <div class="row">
                  <div class="large-9 columns">
                    <table id="users_table">
                      <thead>
                        <th>Email</th>
                        <th>Role</th>
                      </thead>
                      <tbody>
                        <% @plan.users.each do |user| %>
                          <tr>
                            <td><%= user.email %></td>
                            <td><%= PlanUser.where(user_id: user.id, plan_id: @plan.id).first.present? ? PlanUser.where(user_id: user.id, plan_id: @plan.id).first.role : nil %></td>
                            <td><%= link_to "Remove", remove_user_plan_path(plan_id: @plan.id, user_id: user.id), method: :delete %></td>
                          </tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>  
                  <div class="large-3 columns">
                    <a id="new_plan_user_button" href="#" data-reveal-id="new-plan-user" class="button tiny radius"><i class="fi-plus"></i> ADD USERS</a>
                    <%= render 'new_plan_user', :plan => @plan %>
                  </div>
                </div>
            </fieldset>
          </div>
          <div class="large-4 columns end">
            <% if @plan.id.present? && !@plan.draft? %>
              <%= render 'comment_form', plan: @plan, title: "collaborators" %>
            <% end %>
          </div>
        </div>          
      </div>
      <div class="row">
        <div class="small-3 columns input_label">
          <%= f.label :event_type %>
        </div>
        <div class="small-5 columns">
        <%= f.association :event_type,
                              collection: EventType.all,
                              label_method: :name,
                              value_method: :id,
                              include_blank: false,
                              label: false %>
        </div>
        <div class="large-4 columns end">
          <%= render 'comment_form', plan: @plan, title: "event_type" %>
        </div>
      </div>

      <div class="row">
        <div class="small-3 columns input_label">
          <%= f.label :permitter, class: "inline", label: "Permitting Agency", required: true %>
        </div>
        <div class="small-5 columns">
        <%= f.association :permitter,
                          collection: @permitters,
                          label_method: :name,
                          value_method: :id,
                          include_blank: false,
                          label: false,
                          prompt: "(Please select)"%>
        <%= render partial: "permitters/permitter", collection: @permitters %>
        </div>
        <div class="large-4 columns end">
            <%= render 'comment_form', plan: @plan, title: "permitter" %>
          </div>
      </div>
       <div class="row">
        <div class="small-3 columns input_label">
          <%= f.label :permitter, class: "inline", label: "Alcohol Present" %>
        </div>
        <div class="small-5 columns">
          <%= f.input :alcohol, label: "Yes" %>
        </div>
        <div class="large-4 columns end">
          <%= render 'comment_form', plan: @plan, title: "alcohol" %>
        </div>
      </div>
      <hr/>

      <div class="large-12 columns operation-period-container">
        <div class="row">
          <h3>
            Operational Periods
            <span class="add_operation_period_button">
              <%= link_to add_operation_period_path(@plan.operation_periods.count), remote: true, class: "button primary tiny radius right", id: "new_operation_period" do %> 
                <i class="fi-plus"></i> ADD OPERATIONAL PERIOD
              <% end %>
            </span>
          </h3>
        </div>
      <div class="row">
        <ul class="tabs" id="operation-period-tabs" data-tab>
          <% @plan.operation_periods.each_with_index do |operation_period, index| %>
              <%= render 'operation_period_tabs', count: index+1, period: operation_period %>
          <% end %>
        </ul>
        <div class="tabs-content">
          <% @plan.operation_periods.each.with_index do |operation_period, index| %>
            <%= render 'operation_periods/operation_period', operation_period: operation_period, count: index+1, f: f %>
          <% end %>
        </div>
      </div>
    </div>

    <%= render 'plan_agreement' %>

    <div class="large-12 columns text-center actions plan-action">
      <%= f.button :button, class: "button large radius warning", label: false do %>
        <i class="fi-check"></i> SAVE DRAFT
      <% end %>
      <% if @plan.draft? %>
        <%= link_to "SUBMIT PLAN", [ @plan, { plan: { id: @plan.id }, event: "submit" } ], method: "PUT", class: "button large radius" %>
      <% elsif current_user.admin? && !@plan.being_reviewed? %>
        <%= link_to request_revision_plan_path(@plan), class: "button large radius", label: false, method: :post do %>
          <i class="fi-refresh"></i> REQUEST REVISION
        <% end %>
        <%= link_to approve_plan_path(@plan), class: "button large radius success", label: false, data: { confirm: "I know I know, just want to confirm that you are ready to approve this plan." }, method: :post do %>
          <i class="fi-check"></i> APPROVE PLAN
        <% end %>
      <% elsif current_user.admin? && @plan.being_reviewed? %>
        <%= link_to approve_plan_path(@plan), class: "button large radius success", label: false, data: { confirm: "I know I know, just want to confirm that you are ready to approve this plan." }, method: :post do %>
          <i class="fi-check"></i> APPROVE PLAN
        <% end %>
      <% end %>
    </div>

    <% end %> 
  </div>
</div>
